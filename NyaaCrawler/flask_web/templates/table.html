<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport"    content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author"      content="Sergey Pozhilov (GetTemplate.com)">

	<title>種子下載助手</title>

	<link rel="shortcut icon" href="static/images/gt_favicon.png">

	<!-- Bootstrap itself -->
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" type="text/css">

	<!-- Custom styles -->
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/magister.css') }}">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/checkbox.css') }}">
	<!-- Fonts -->
	<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	<link href='http://fonts.googleapis.com/css?family=Wire+One' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker3.min.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.9.1/sweetalert2.min.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.css" />
	<style>
		body {
			overflow:hidden;
		}
		@media (min-width: 1200px) {
			.container{
				width: 1800px;
			}
		}
        .bkcolor{
            background-color: rgba(169, 160, 121, 0.5);
        }

	</style>
</head>

<!-- use "theme-invert" class on bright backgrounds, also try "text-shadows" class -->
<body class="theme-invert">

<nav class="mainmenu">
	<div class="container">
		<div class="dropdown">
			<button type="button" class="navbar-toggle" data-toggle="dropdown"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
			<!-- <a data-toggle="dropdown" href="#">Dropdown trigger</a> -->
			<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
				<li><a href="#head" class="active">首頁</a></li>
				<li><a href="#about">資料管理</a></li>
				<li><a href="#themes">爬蟲控制</a></li>
			</ul>
		</div>
	</div>
</nav>


<!-- Main (Home) section -->
<section class="section" id="head">
	<div class="container" class="bkcolor">
        <div class="row">
            <div class="col-sm-2">
                <label for="keyword">文章標題</label>
                  <input type="text" class="form-control" id="keyword">
            </div>
            <div class="col-sm-2">
                <label for="fromDate">發佈日期(起):</label>
                <input type="text" class="form-control" id="fromDate">
            </div>
            <div class="col-sm-2">
                <label for="toDate">發佈日期(起):</label>
                <input type="text" class="form-control" id="toDate">
            </div>
            <div class="col-sm-2">
                <label for="minSize">檔案大小(起):</label>
                <input type="number" class="form-control" id="minSize">
            </div>
            <div class="col-sm-2">
                <label for="maxSize">檔案大小(迄):</label>
                <input type="number" class="form-control" id="maxSize">
            </div>
            <div class="col-sm-2">
                <label for="maxage">最近日期:</label>
                <input type="number" class="form-control" id="maxage">
            </div>
        </div>
        <div class="row">
			<div class="col-sm-2 col-sm-offset-0" class="bkcolor" style="margin-top:10px;margin-bottom:10px">
				    <input type="checkbox" id="cbUncensored" />
    				<label for="cbUncensored">Uncensored</label>
			</div>
			<div class="col-sm-1 col-sm-offset-7" class="bkcolor" style="margin-top:10px;margin-bottom:10px">
                <button type="button" id="loadImage" class="btn btn-primary" style="width:120px">載入預覽圖</button>
            </div>
            <div class="col-sm-1 col-sm-offset-0" class="bkcolor" style="margin-top:10px;margin-bottom:10px">
                <button type="button" id="search" class="btn btn-primary" style="width:120px">搜尋</button>
            </div>
        </div>
		<div class="row" class="bkcolor">
			<div class="col-sm-12" class="bkcolor">
				    <table id="table">
					</table>
			</div>

		</div> <!-- /row -->

	</div>

	<div id="previewImage" style="display:none;">
		<!--<a href="#ImgBase64" data-fancybox="0" data-options='{"downloadlink" : "test get download link"}'>-->
		<!--<img src='' ID='ImgBase64'>-->
		<!--</a>-->
		<!--<a href="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/SIPI_Jelly_Beans_4.1.07.tiff/lossy-page1-220px-SIPI_Jelly_Beans_4.1.07.tiff.jpg" data-fancybox="0" data-options='{"downloadlink" : "test get download link","articlelink":""}' />-->
	</div>
</section>

<!-- Second (About) section -->
<section class="section" id="about">
	<div class="container">
		<h1>區塊二</h1>
	</div>
</section>

<!-- Third (Works) section -->
<section class="section" id="themes">
	<div class="container">
		<h1>區塊三</h1>
	</div>
</section>

<!-- Load js libs only when the page is loaded. -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!--<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>-->
<script type="text/javascript" src="{{ url_for('static', filename='js/modernizr.custom.72241.js') }}"></script>
<!-- Custom template scripts -->
  <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <!--<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">-->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
  <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>

<script type="text/javascript" src="{{ url_for('static', filename='js/magister.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.9.1/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.js"></script>

</body>
	<script type='text/javascript'>

	<!--設定ajax pool 當執行其他動作時 abort所有的ajax request 避免系統卡死在ajax request-->
		$(function() {
			$.xhrPool = [];
			$.xhrPool.abortAll = function() {
				$(this).each(function(i, jqXHR) {   //  cycle through list of recorded connection
					jqXHR.abort();  //  aborts connection
					$.xhrPool.splice(i, 1); //  removes from list by index
				});
			}
			$.ajaxSetup({
				beforeSend: function(jqXHR) { $.xhrPool.push(jqXHR); }, //  annd connection to list
				complete: function(jqXHR) {
					var i = $.xhrPool.indexOf(jqXHR);   //  get index for current connection completed
					if (i > -1) $.xhrPool.splice(i, 1); //  removes from list by index
				}
			});
		})

		//所有row的資料
		var rowData = {}
		var table=$("#table")

		$(document).ready(function() {
			//row的預覽圖按鈕點擊 依照點擊的row的index 開啟不同group的gallery
			 table.on('click', '.fancybox-trigger' , function (event) {
			     var gallery = $("[data-fancybox='" + $(this).attr('trigger-rel') + "']");
			     if(gallery.length>0){
                     gallery.eq(0).trigger('click');
                 }else{
			         swal("沒有預覽圖","", "error")
				 }

             });

			  table.on('click-row.bs.table', function (e, row, $element) {
					$('.success').removeClass('success');
        			$($element).addClass('success');
				});

             //預載入圖片按鈕點擊
			$('#loadImage').click(function(){
				$.xhrPool.abortAll();
				BuildGallery();
			});
         });

		// Create template for download button
		$.fancybox.defaults.btnTpl.download = '<a class="fancybox-button fancybox-download"><i class="fa fa-arrow-down fa-inverse " aria-hidden="true"></i></a>';
		$.fancybox.defaults.btnTpl.article = '<a class="fancybox-button fancybox-article"><i class="fa fa-link fa-inverse " aria-hidden="true"></i></a>';

		// Choose what buttons to display by default
		$.fancybox.defaults.buttons = [
		  'fullScreen',
		  'thumbs',
		  'download',
			'article',
		  'close'
		];

		//初始化gallery

		$().fancybox({
			selector: '[data-fancybox]',//使用selector 未來動態產生的fancybox都能套用到
			thumbs: false,
			hash: true,
			toolbar  : true,
			smallBtn : true,
			thumbs : {
				autoStart : true

			},
			//自訂fancybox 的toolbar按鈕 加上下載連結和文章連結
			beforeShow : function( instance, current ) {
				$('.fancybox-download').attr('href', current.opts.downloadlink).attr("target","_blank");
				$('.fancybox-article').attr('href', current.opts.articlelink).attr("target","_blank");
			}
		});


		table.bootstrapTable({
			url:"{{ url_for('post') }}",
			sidePagination:'server',
			height:800,
			method:'get',
			queryParams:function(params){
                 var q = {
                            limit: params.limit,
                            offset: params.offset,
                            keyword : $("#keyword").val(),
                            fromDate : $("#fromDate").val(),
                            toDate : $("#toDate").val(),
                            minSize : $("#minSize").val(),
                            maxSize : $("#maxSize").val(),
                            maxage : $("#maxage").val(),
					 		IsUncensored:$("#cbUncensored").is(":checked"),
                            sort : params.sort,
                            search: params.search,
                            order: params.order
                         };

                        return q;
            },
			pageSize:20,
			undefinedText:'<i class="fa fa-question" aria-hidden="true"></i>',
			pagination:true,
			pageList:[10,50,100],
			//當換分頁時 將放預覽圖圖片的div清空
			onPageChange:function(page,size){
				$("#previewImage").html("")
			},
			//加載成功時 取得所有row的資料 存到全域變數
			onLoadSuccess:function(data){
			    //從data取得預覽圖位址
				rowData = data.rows
			},
            columns: [
                        {
                            field: "title",
                            title: "標題",
                            sortable: true,
                            width:'30%'
                        },
                        {
                            field: "torrent",
                            title: "種子",
                            sortable: true,
                            width: '5%',
                            formatter:function(value){
                                return '<a href="'+value+'">下載 <i class="fa fa-download" aria-hidden="true"></i></a>'
                            }
                        },
                        {
                            field: "size",
                            title: "檔案大小",
                            sortable: true,
                            width: '5%',
                            formatter:function(value){
                                return value+' MB'
                            }
                        },
                        {
                            field: "articlelink",
                            title: "文章連結",
                            sortable: true,
                            width: '5%',
                            formatter:function(value){
                                return '<a href="'+value+'" target="_blank">文章連結 <i class="fa fa-external-link"></i></a>'
                            }
                        },
                        {
                            field: "ImagePath",
                            title: "預覽圖連結",
                            sortable: true,
                            width: '5%',
                            visible:true,
                            formatter:function(value,row,index){
                                return previewButtonTemplate(index);
                            }
                        },
				        {
                            field: "ImageStatus",
                            title: "預覽圖狀態",
                            sortable: true,
                            width: '3%',
                            visible:true
                        },
                        {
                            field: "pubDate",
                            title: "發佈日期",
                            sortable: true,
                            width: '10%'
                        },

						{
                            field: "seeder",
                            title: "seeder",
                            sortable: true,
                            width: '5%',
							formatter:function(value,row,index){
                                return value?value:0;
                            }
                        },
				                        {
                            field: "leecher",
                            title: "leecher",
                            sortable: true,
                            width: '5%',
							formatter:function(value,row,index){
                                return value?value:0;
                            }
                        },
				                        {
                            field: "downloads",
                            title: "下載數量",
                            sortable: true,
                            width: '5%',
							formatter:function(value,row,index){
                                return value?value:0;
                            }
                        }
                    ]
		});

		function previewButtonTemplate(index){
		    return '<button class="btn btn-primary fancybox-trigger" trigger-rel="'+index+'"> <i class="fa fa-picture-o" aria-hidden="true"></i> 預覽 </button>';
		}

		$('#search').click(function () {
		    $.xhrPool.abortAll();
            table.bootstrapTable('refresh');
        });
		//當在input field按下enter時 自動重整表單
	   $(':input').on('keypress', function (e) {
			 if(e.which === 13){
				$.xhrPool.abortAll();
            	table.bootstrapTable('refresh');
			 }
	   });

		$('#fromDate,#toDate').datepicker({
            format: "yyyy-mm-dd",
            language: "zh-TW"
        });


		//取得預覽圖 插入到html裡
		function BuildGallery(){
		    //console.log(rowData);
		    if(rowData.length==0)
		        return;
		    rowData.forEach(function(rowObj,index) {
//		        呼叫ajax時 將狀態更新為載入中
				table.bootstrapTable('updateCell',{index:index,field:'ImageStatus',value:'<i class="fa fa-spinner" aria-hidden="true"></i>'});
                $.ajax({
					url: "/getImage",
					type: "POST",
					data: JSON.stringify({ImagePath: rowObj.ImagePath}),
					contentType: "application/json; charset=utf-8",
					success: function(data) {
					    //loop預覽圖陣列 組成圖片gallery的html 用rowData的index當群組的key
						var imgLink = ''
					    data.forEach(function(element,imgIndex) {
					        if(element) {
                                imgLink += "<a href=\"#ImgBase" + index + imgIndex + "\" data-fancybox=\"" + index + "\" data-options='{\"downloadlink\" : \"" + rowObj.torrent + "\",\"articlelink\":\"" + rowObj.articlelink + "\"}'>"
                                imgLink += "<img src=\"" + element + "\" ID=\"ImgBase" + index + imgIndex + "\">"
                                imgLink += "</a>"
                            }
						});
						//將圖片html插入到div 讓gallery套件能讀取
						$("#previewImage").append(imgLink)

						//更新預覽圖狀態 成功為勾勾 失敗為叉叉
						var icon = '<i class="fa fa-check-circle" aria-hidden="true"></i>'
						if($('*[data-fancybox="'+index+'"]').length==0)
							icon = '<i class="fa fa-times" aria-hidden="true"></i>'
						table.bootstrapTable('updateCell',{index:index,field:'ImageStatus',value:icon});
					}
				});
            });
		}
	</script>
</html>